<!DOCTYPE html><html><head>
      <title>2. MetaprogrammingNotes</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////home/tanvir/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.5.17/node_modules/@shd101wyy/mume/dependencies/katex/katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /* http://prismjs.com/download.html?themes=prism&languages=markup+css+clike+javascript+abap+actionscript+ada+apacheconf+apl+applescript+asciidoc+aspnet+autoit+autohotkey+bash+basic+batch+c+brainfuck+bro+bison+csharp+cpp+coffeescript+ruby+css-extras+d+dart+django+diff+docker+eiffel+elixir+erlang+fsharp+fortran+gherkin+git+glsl+go+graphql+groovy+haml+handlebars+haskell+haxe+http+icon+inform7+ini+j+jade+java+jolie+json+julia+keyman+kotlin+latex+less+livescript+lolcode+lua+makefile+markdown+matlab+mel+mizar+monkey+nasm+nginx+nim+nix+nsis+objectivec+ocaml+oz+parigp+parser+pascal+perl+php+php-extras+powershell+processing+prolog+properties+protobuf+puppet+pure+python+q+qore+r+jsx+reason+rest+rip+roboconf+crystal+rust+sas+sass+scss+scala+scheme+smalltalk+smarty+sql+stylus+swift+tcl+textile+twig+typescript+vbnet+verilog+vhdl+vim+wiki+xojo+yaml */
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #a67f59;
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}

/* highlight */
pre[data-line] {
	position: relative;
	padding: 1em 0 1em 3em;
  }
  pre[data-line] .line-highlight-wrapper {
	position: absolute;
	top: 0;
	left: 0;
	background-color: transparent;
	display: block;
	width: 100%;
  }
  
  pre[data-line] .line-highlight {
	position: absolute;
	left: 0;
	right: 0;
	padding: inherit 0;
	margin-top: 1em;
	background: hsla(24, 20%, 50%,.08);
	background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
	pointer-events: none;
	line-height: inherit;
	white-space: pre;
  }
  
  pre[data-line] .line-highlight:before, 
  pre[data-line] .line-highlight[data-end]:after {
	content: attr(data-start);
	position: absolute;
	top: .4em;
	left: .6em;
	min-width: 1em;
	padding: 0 .5em;
	background-color: hsla(24, 20%, 50%,.4);
	color: hsl(24, 20%, 95%);
	font: bold 65%/1.5 sans-serif;
	text-align: center;
	vertical-align: .3em;
	border-radius: 999px;
	text-shadow: none;
	box-shadow: 0 1px white;
  }
  
  pre[data-line] .line-highlight[data-end]:after {
	content: attr(data-end);
	top: auto;
	bottom: .4em;
  }@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:400;src:local('Roboto Mono'),local('RobotoMono-Regular'),url(https://fonts.gstatic.com/s/robotomono/v7/L0x5DF4xlVMF-BfR8bXMIjhLq3o.ttf) format('truetype')}@font-face{font-family:'Source Sans Pro';font-style:normal;font-weight:300;src:local('Source Sans Pro Light'),local('SourceSansPro-Light'),url(https://fonts.gstatic.com/s/sourcesanspro/v13/6xKydSBYKcSV-LCoeQqfX1RYOo3ik4zwlxdr.ttf) format('truetype')}@font-face{font-family:'Source Sans Pro';font-style:normal;font-weight:400;src:local('Source Sans Pro Regular'),local('SourceSansPro-Regular'),url(https://fonts.gstatic.com/s/sourcesanspro/v13/6xK3dSBYKcSV-LCoeQqfX1RYOo3qOK7g.ttf) format('truetype')}@font-face{font-family:'Source Sans Pro';font-style:normal;font-weight:600;src:local('Source Sans Pro SemiBold'),local('SourceSansPro-SemiBold'),url(https://fonts.gstatic.com/s/sourcesanspro/v13/6xKydSBYKcSV-LCoeQqfX1RYOo3i54rwlxdr.ttf) format('truetype')}*{-webkit-font-smoothing:antialiased;-webkit-overflow-scrolling:touch;-webkit-tap-highlight-color:rgba(0,0,0,0);-webkit-text-size-adjust:none;-webkit-touch-callout:none;box-sizing:border-box}body:not(.ready){overflow:hidden}body:not(.ready) .app-nav,body:not(.ready)>nav,body:not(.ready) [data-cloak]{display:none}div#app{font-size:30px;font-weight:lighter;margin:40vh auto;text-align:center}div#app:empty:before{content:"Loading..."}.emoji{height:19.2px;height:1.2rem;vertical-align:middle}.progress{background-color:#42b983;background-color:var(--theme-color, #42b983);height:2px;left:0;position:fixed;right:0;top:0;transition:width .2s,opacity .4s;width:0;z-index:5}.search .search-keyword,.search a:hover{color:#42b983;color:var(--theme-color, #42b983)}.search .search-keyword{font-style:normal;font-weight:700}body,html{height:100%}body{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;color:#34495e;font-family:Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:15px;letter-spacing:0;margin:0;overflow-x:hidden}img{max-width:100%}a[disabled]{cursor:not-allowed;opacity:.6}kbd{color:#34495e;border:1px solid #ccc;border-radius:3px;display:inline-block;font-size:12px !important;line-height:12px;margin-bottom:3px;padding:3px 5px;vertical-align:middle}.task-list-item{list-style-type:none}li input[type=checkbox]{margin:0 .2em .25em -1.6em;vertical-align:middle}.app-nav{left:0;margin:25px 60px 0 0;position:absolute;right:0;text-align:right;z-index:2}.app-nav p{margin:0}.app-nav>a{margin:0 16px;margin:0 1rem;padding:5px 0}.app-nav li,.app-nav ul{display:inline-block;list-style:none;margin:0}.app-nav a{color:inherit;font-size:16px;text-decoration:none;transition:color .3s}.app-nav a.active,.app-nav a:hover{color:#42b983;color:var(--theme-color, #42b983)}.app-nav a.active{border-bottom:2px solid #42b983;border-bottom:2px solid var(--theme-color, #42b983)}.app-nav li{display:inline-block;margin:0 16px;margin:0 1rem;padding:5px 0;position:relative}.app-nav li ul{background-color:#fff;border:1px solid #ddd;border-bottom-color:#ccc;border-radius:4px;box-sizing:border-box;display:none;max-height:calc(100vh - 61px);overflow-y:scroll;padding:10px 0;position:absolute;right:-15px;text-align:left;top:100%;white-space:nowrap}.app-nav li ul li{display:block;font-size:14px;line-height:16px;line-height:1rem;margin:0;margin:8px 14px;white-space:nowrap}.app-nav li ul a{display:block;font-size:inherit;margin:0;padding:0}.app-nav li ul a.active{border-bottom:0}.app-nav li:hover ul{display:block}.app-nav.no-badge{margin-right:25px}.github-corner{border-bottom:0;position:fixed;right:0;text-decoration:none;top:0;z-index:1}.github-corner svg{color:#fff;fill:#42b983;fill:var(--theme-color, #42b983);height:80px;width:80px}.github-corner:hover .octo-arm{-webkit-animation:a .56s ease-in-out;animation:a .56s ease-in-out}main{display:block;position:relative;width:100vw;height:100%;z-index:0}.anchor{display:inline-block;text-decoration:none;transition:all .3s}.anchor span{color:#34495e}.anchor:hover{text-decoration:underline}.sidebar{border-right:1px solid rgba(0,0,0,0.07);overflow-y:auto;padding:40px 0 0;top:0;bottom:0;left:0;position:absolute;transition:-webkit-transform .25s ease-out;transition:transform .25s ease-out;transition:transform .25s ease-out,-webkit-transform .25s ease-out;width:300px;z-index:3}.sidebar>h1{margin:0 auto 16px;margin:0 auto 1rem;font-size:24px;font-size:1.5rem;font-weight:300;text-align:center}.sidebar>h1 a{color:inherit;text-decoration:none}.sidebar>h1 .app-nav{display:block;position:static}.sidebar .sidebar-nav{line-height:2em;padding-bottom:40px}.sidebar ul{margin:0;padding:0}.sidebar li>p{font-weight:700;margin:0}.sidebar ul,.sidebar ul li{list-style:none}.sidebar ul li a{border-bottom:none;display:block}.sidebar ul li ul{padding-left:20px}.sidebar::-webkit-scrollbar{width:4px}.sidebar::-webkit-scrollbar-thumb{background:transparent;border-radius:4px}.sidebar:hover::-webkit-scrollbar-thumb{background:hsla(0,0%,53%,0.4)}.sidebar:hover::-webkit-scrollbar-track{background:hsla(0,0%,53%,0.1)}.sidebar-toggle{background-color:transparent;background-color:hsla(0,0%,100%,0.8);border:0;outline:none;padding:10px;bottom:0;left:0;position:absolute;text-align:center;transition:opacity .3s;width:30px;width:284px;z-index:4}.sidebar-toggle .sidebar-toggle-button:hover{opacity:.4}.sidebar-toggle span{background-color:#42b983;background-color:var(--theme-color, #42b983);display:block;margin-bottom:4px;width:16px;height:2px}body.sticky .sidebar,body.sticky .sidebar-toggle{position:fixed}.content{padding-top:60px;top:0;right:0;bottom:0;left:300px;position:absolute;transition:left .25s ease}.markdown-preview>*{box-sizing:border-box;font-size:inherit}.markdown-preview>:first-child{margin-top:0 !important}.markdown-preview hr{border:none;border-bottom:1px solid #eee;margin:2em 0}.markdown-preview table{border-collapse:collapse;border-spacing:0;display:block;margin-bottom:16px;margin-bottom:1rem;overflow:auto;width:100%}.markdown-preview th{font-weight:700}.markdown-preview td,.markdown-preview th{border:1px solid #ddd;padding:6px 13px}.markdown-preview tr{border-top:1px solid #ccc}.markdown-preview p.tip,.markdown-preview tr:nth-child(2n){background-color:#f8f8f8}.markdown-preview p.tip{border-bottom-right-radius:2px;border-left:4px solid #f66;border-top-right-radius:2px;margin:2em 0;padding:12px 24px 12px 30px;position:relative}.markdown-preview p.tip code{background-color:#efefef}.markdown-preview p.tip em{color:#34495e}.markdown-preview p.tip:before{background-color:#f66;border-radius:100%;color:#fff;content:"!";font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:14px;font-weight:700;left:-12px;line-height:20px;position:absolute;width:20px;height:20px;text-align:center;top:14px}.markdown-preview p.warn{background:rgba(66,185,131,0.1);border-radius:2px;padding:16px;padding:1rem}body.close .sidebar{-webkit-transform:translateX(-300px);transform:translateX(-300px)}body.close .sidebar-toggle{width:auto}body.close .content{left:0}@media print{.app-nav,.github-corner,.sidebar,.sidebar-toggle{display:none}}@media screen and (max-width:768px){.github-corner,.sidebar,.sidebar-toggle{position:fixed}.app-nav{margin-top:16px}.app-nav li ul{top:30px}main{height:auto;overflow-x:hidden}.sidebar{left:-300px;transition:-webkit-transform .25s ease-out;transition:transform .25s ease-out;transition:transform .25s ease-out,-webkit-transform .25s ease-out}.content{left:0;max-width:100vw;position:static;padding-top:20px;transition:-webkit-transform .25s ease;transition:transform .25s ease;transition:transform .25s ease,-webkit-transform .25s ease}.app-nav,.github-corner{transition:-webkit-transform .25s ease-out;transition:transform .25s ease-out;transition:transform .25s ease-out,-webkit-transform .25s ease-out}.sidebar-toggle{background-color:transparent;width:auto;padding:30px 30px 10px 10px}body.close .sidebar{-webkit-transform:translateX(300px);transform:translateX(300px)}body.close .sidebar-toggle{background-color:hsla(0,0%,100%,0.8);transition:background-color 1s;width:284px;padding:10px}body.close .content{-webkit-transform:translateX(300px);transform:translateX(300px)}body.close .app-nav,body.close .github-corner{display:none}.github-corner .octo-arm{-webkit-animation:a .56s ease-in-out;animation:a .56s ease-in-out}.github-corner:hover .octo-arm{-webkit-animation:none;animation:none}}@-webkit-keyframes a{0%,to{-webkit-transform:rotate(0);transform:rotate(0)}20%,60%{-webkit-transform:rotate(-25deg);transform:rotate(-25deg)}40%,80%{-webkit-transform:rotate(10deg);transform:rotate(10deg)}}@keyframes a{0%,to{-webkit-transform:rotate(0);transform:rotate(0)}20%,60%{-webkit-transform:rotate(-25deg);transform:rotate(-25deg)}40%,80%{-webkit-transform:rotate(10deg);transform:rotate(10deg)}}section.cover{-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-position:50%;background-repeat:no-repeat;background-size:cover;height:100vh;display:none}section.cover .cover-main{-webkit-box-flex:1;-ms-flex:1;flex:1;margin:-20px 16px 0;text-align:center;z-index:1}section.cover a{color:inherit}section.cover a,section.cover a:hover{text-decoration:none}section.cover p{line-height:24px;line-height:1.5rem;margin:1em 0}section.cover h1{color:inherit;font-size:40px;font-size:2.5rem;font-weight:300;margin:10px 0 40px;margin:.625rem 0 2.5rem;position:relative;text-align:center}section.cover h1 a{display:block}section.cover h1 small{bottom:-7px;bottom:-0.4375rem;font-size:16px;font-size:1rem;position:absolute}section.cover blockquote{font-size:24px;font-size:1.5rem;text-align:center}section.cover ul{line-height:1.8;list-style-type:none;margin:1em auto;max-width:500px;padding:0}section.cover .cover-main>p:last-child a{border-color:#42b983;border:1px solid var(--theme-color, #42b983);border-radius:2rem;box-sizing:border-box;color:#42b983;color:var(--theme-color, #42b983);display:inline-block;font-size:16.8px;font-size:1.05rem;letter-spacing:1.6px;letter-spacing:.1rem;margin-right:16px;margin-right:1rem;padding:.75em 32px;padding:.75em 2rem;text-decoration:none;transition:all .15s ease}section.cover .cover-main>p:last-child a:last-child{background-color:#42b983;background-color:var(--theme-color, #42b983);color:#fff;margin-right:0}section.cover .cover-main>p:last-child a:last-child:hover{color:inherit;opacity:.8}section.cover .cover-main>p:last-child a:hover{color:inherit}section.cover blockquote>p>a{border-bottom:2px solid #42b983;border-bottom:2px solid var(--theme-color, #42b983);transition:color .3s}section.cover blockquote>p>a:hover{color:#42b983;color:var(--theme-color, #42b983)}section.cover.show{display:-webkit-box;display:-ms-flexbox;display:flex}section.cover.has-mask .mask{background-color:#fff;opacity:.8;position:absolute;width:100%;height:100%}.sidebar,body{background-color:#fff}.sidebar{color:#364149}.sidebar li{margin:6px 0 6px 15px}.sidebar ul li a{color:#505d6b;font-size:14px;font-weight:400;overflow:hidden;text-decoration:none;text-overflow:ellipsis;white-space:nowrap}.sidebar ul li a:hover{text-decoration:underline}.sidebar ul li ul{padding:0}.sidebar ul li.active>a{border-right:2px solid;color:#42b983;color:var(--theme-color, #42b983);font-weight:600}.app-sub-sidebar li:before{content:"-";padding-right:4px;float:left}.markdown-preview h1,.markdown-preview h2,.markdown-preview h3,.markdown-preview h4,.markdown-preview strong{color:#2c3e50;font-weight:600}.markdown-preview a{color:#42b983;color:var(--theme-color, #42b983);font-weight:600}.md-sidebar-toc a{color:#42b983;font-weight:600}.markdown-preview h1{font-size:32px;font-size:2rem;margin:0 0 16px;margin:0 0 1rem}.markdown-preview h2{font-size:28px;font-size:1.75rem;margin:45px 0 12.8px;margin:45px 0 .8rem}.markdown-preview h3{font-size:24px;font-size:1.5rem;margin:40px 0 9.6px;margin:40px 0 .6rem}.markdown-preview h4{font-size:20px;font-size:1.25rem}.markdown-preview h5,.markdown-preview h6{font-size:16px;font-size:1rem}.markdown-preview h6{color:#777}.markdown-preview figure,.markdown-preview p{margin:1.2em 0}.markdown-preview ol,.markdown-preview p,.markdown-preview ul{line-height:25.6px;line-height:1.6rem;word-spacing:.8px;word-spacing:.05rem}.markdown-preview ol,.markdown-preview ul{padding-left:24px;padding-left:1.5rem}.markdown-preview blockquote{border-left:4px solid #42b983;border-left:4px solid var(--theme-color, #42b983);color:#858585;background-color:#f0f0f0;margin:2em 0;padding-left:20px}.markdown-preview blockquote p{font-weight:600;margin-left:0}.markdown-preview iframe{margin:1em 0}.markdown-preview em{color:#7f8c8d}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
.markdown-preview.markdown-preview {
  color: rgba(0, 0, 0, 0.712);
}
.markdown-preview.markdown-preview .markdown-preview a:hover {
  color: blue;
  text-decoration: underline;
}
.markdown-preview.markdown-preview pre[data-role="codeBlock"] {
  font-size: 13px !important;
  background-color: whitesmoke;
}
.markdown-preview.markdown-preview h1 {
  color: #116062;
  font-size: 40px;
  font-weight: 50;
  margin-bottom: -6px;
  margin-top: -6px;
  font-family: "Anton";
  font-style: italic;
}
.markdown-preview.markdown-preview h2 {
  color: #020202;
  font-size: 20px;
  margin-bottom: 0px;
  margin-top: 0px;
  font-family: "Microsoft Yahei";
  font-style: italic;
}
.markdown-preview.markdown-preview h3 {
  color: #020202;
  font-size: 15px;
  margin-bottom: 0px;
  margin-top: 0px;
  font-family: "Microsoft Yahei";
  font-style: normal;
}
.markdown-preview.markdown-preview code {
  color: rgba(110, 5, 5, 0.739);
  font-weight: 550;
}
.markdown-preview.markdown-preview blockquote {
  margin-bottom: 40px;
  margin-top: 30px;
  background-color: #ffffff;
  padding: 0.3px;
  padding-left: 5px;
}
.markdown-preview.markdown-preview blockquote p {
  color: #5f0303;
  font-size: 14px;
  font-family: "Microsoft Yahei";
  font-style: italic;
  font-weight: 100;
  line-height: 1.5;
}
@media print {
  .markdown-preview.markdown-preview {
    font-size: 18px;
  }
}

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <h1 class="mume-header" id="introduction-to-metaprogramming-code-that-creates-code">Introduction to metaprogramming: &quot;Code that creates code&quot;</h1>

<p>This is pretty much borrowed from David Sanders Julia 2016 talk.</p>
<p>Julia has strong <strong>metaprogramming</strong> capabilities. What does this mean?</p>
<blockquote>
<p><strong>meta</strong>: something on a higher level</p>
</blockquote>
<p><strong>metaprogramming</strong> = &quot;higher-level programming&quot;</p>
<p>i.e. writing code (a program) to manipulate not data, but code (that itself manipulates data)</p>
<h2 class="mume-header" id="motivating-example">Motivating example</h2>

<p>Metaprogramming has many different uses, several of which we will explore. It is often a way to add, or change, the syntax of Julia, to write a &quot;domain-specific language&quot; (DSL), that converts a simple syntax (but that is not standard Julia syntax) into true Julia code.</p>
<p>As a motivating example, we might like to be able to write what is called Wilkinson-type polynomials.
The <a href="https://en.wikipedia.org/wiki/Wilkinson&apos;s_polynomial">Wilkinson polynomial</a> is</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mn>20</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>:</mo><mo>=</mo><mo stretchy="false">(</mo><mi>x</mi><mo>&#x2212;</mo><mn>1</mn><mo stretchy="false">)</mo><mo>&#x22C5;</mo><mo stretchy="false">(</mo><mi>x</mi><mo>&#x2212;</mo><mn>2</mn><mo stretchy="false">)</mo><mo>&#x22C5;</mo><mo>&#x22EF;</mo><mo>&#x22C5;</mo><mo stretchy="false">(</mo><mi>x</mi><mo>&#x2212;</mo><mn>20</mn><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>&#x220F;</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mn>20</mn></munderover><mo stretchy="false">(</mo><mi>x</mi><mo>&#x2212;</mo><mi>i</mi><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">p_{20}(x) := (x-1) \cdot (x-2) \cdot \cdots \cdot (x-20) = \prod_{i=1}^{20} (x-i).</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">20</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x22C5;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x22C5;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.44445em;vertical-align:0em;"></span><span class="minner">&#x22EF;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x22C5;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">20</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.0787820000000004em;vertical-align:-1.277669em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8011130000000004em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">&#x220F;</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">20</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">&#x2212;</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mord">.</span></span></span></span></span></p>
<p>[Polynomials like this are interesting, since the eigenvalues of the associated &quot;companion matrix&quot;, which are used to find the roots of the polynomial, are very sensitive to perturbations of the coefficients of the polynomial.]</p>
<p>Suppose we wish to define this polynomial in Julia. The simple way would be to write it out explicitly:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">p_5<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>
</pre><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>10</mn></msub></mrow><annotation encoding="application/x-tex">p_{10}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">10</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is already a pain to type by hand, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>20</mn></msub></mrow><annotation encoding="application/x-tex">p_{20}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">20</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> more so, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>100</mn></msub></mrow><annotation encoding="application/x-tex">p_{100}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">100</span></span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is basically impossible. But this is just a case of repetition, and computers are designed for that. One possible definition uses a <code>for</code> loop and with the help of anonymous function to define the function <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">p_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">&#x200B;</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia"><span class="token keyword">function</span> wilkinson<span class="token punctuation">(</span>n<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
    result <span class="token operator">=</span> x <span class="token operator">-</span> <span class="token number">1</span>
    
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">2</span><span class="token punctuation">:</span>n
        result <span class="token operator">*=</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> i<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    
    result
<span class="token keyword">end</span>

p<span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=</span> x <span class="token operator">-</span><span class="token operator">&gt;</span> wilkinson<span class="token punctuation">(</span>n<span class="token punctuation">,</span> x<span class="token punctuation">)</span>

p<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3.1</span><span class="token punctuation">)</span>

</pre><p>It seems, though, that it should be possible to use the original definition of the function to write the equivalent of the following for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">n=100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">100</span></span></span></span>.</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">p_5<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>
</pre><p>In other languages, this would often be accomplished by manipulating strings that represent the &quot;surface syntax&quot;, i.e. the string of characters that you would actually type, and then evaluate this string. However, in Julia</p>
<p><strong>we never use strings for this</strong>, since Julia has a way to <strong>refer to Julia code objects within Julia</strong>. So Julia codes are objects and you can also manipulate them like manipulate any other things in Julia.</p>
<h2 class="mume-header" id="expressions">Expressions</h2>

<p>Let&apos;s take the simplest polynomial, that we write as <code>(x-1) * (x-2)</code>. We can view this as a piece of Julia code, called an <strong>expression</strong>, and can tell Julia this as follows:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">ex <span class="token operator">=</span> <span class="token keyword">quote</span>   
        <span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>

<span class="token comment"># or direct way</span>

ex <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> 

typeof<span class="token punctuation">(</span>ex<span class="token punctuation">)</span> <span class="token comment">#What does Julia think this is?</span>

ex
</pre><p>We see that Julia has a type <code>Expr</code> that represents an <strong>expression object</strong>, that we can think of as a &quot;Julia code snippet&quot;. Now if we would like to be able to execute this code; we can do so with <code>eval</code> (&quot;evaluate&quot;):</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">eval<span class="token punctuation">(</span>ex<span class="token punctuation">)</span> <span class="token comment"># We see that `x` is not defined,</span>
</pre><p>If we give <code>x</code> a value first, then it works:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">x <span class="token operator">=</span> <span class="token number">3.5</span>
<span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># works</span>
eval<span class="token punctuation">(</span>ex<span class="token punctuation">)</span>
</pre><p>For example, we can try to write a simple formula evaluator:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">formula <span class="token operator">=</span> <span class="token string">&quot;3x^2 + 4x - 3sin(x)&quot;</span>
eval<span class="token punctuation">(</span>formula<span class="token punctuation">)</span> <span class="token comment">#This does not do what we expect, since we have a string, not a Julia expression:</span>
typeof<span class="token punctuation">(</span>formula<span class="token punctuation">)</span>
formula2 <span class="token operator">=</span> Meta<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>formula<span class="token punctuation">)</span>  <span class="token comment"># To convert this string into an expression, we use `parse`:</span>
eval<span class="token punctuation">(</span>formula2<span class="token punctuation">)</span>
</pre><p>Note that the really hard work, that of parsing the expression, i.e. converting it into an internal representation in terms of a tree, has already been done for us by Julia. It is thus, happily, usually not necessary for us to write our own parser; we just leverage Julia&apos;s own! This is one of many ways in which Julia minimizes the work that we need to do, compared to other languages.</p>
<h2 class="mume-header" id="structure-of-expressions">Structure of <code>Expr</code>essions</h2>

<p>An expression object of type <code>Expr</code> has an internal structure that corresponds to the <strong>abstract syntax tree</strong> (AST) of the expression, i.e. a tree, whose nodes are operations, and whose children are subtrees. We can see this in two ways, using <code>dump</code>:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">ex <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
dump<span class="token punctuation">(</span>ex<span class="token punctuation">)</span>


<span class="token comment">## print the tree with the nice package</span>
<span class="token keyword">using</span> AbstractTrees
print_tree<span class="token punctuation">(</span>ex<span class="token punctuation">)</span>


</pre><pre class="language-text">julia&gt; dump(ex)
Expr
head: Symbol call
args: Array{Any}((3,))
    1: Symbol *
    2: Expr
    head: Symbol call
    args: Array{Any}((3,))
        1: Symbol -
        2: Symbol x
        3: Int64 1
    3: Expr
    head: Symbol call
    args: Array{Any}((3,))
        1: Symbol -
        2: Symbol x
        3: Int64 2

julia&gt; using AbstractTrees

julia&gt; print_tree(ex)
Expr(:call)
&#x251C;&#x2500; :*
&#x251C;&#x2500; Expr(:call)
&#x2502;  &#x251C;&#x2500; :-
&#x2502;  &#x251C;&#x2500; :x
&#x2502;  &#x2514;&#x2500; 1
&#x2514;&#x2500; Expr(:call)
&#x251C;&#x2500; :-
&#x251C;&#x2500; :x
&#x2514;&#x2500; 2
</pre>
<p>which shows everything [up to a pre-determined depth] in detail, or</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">Meta<span class="token punctuation">.</span>show_sexpr<span class="token punctuation">(</span>ex<span class="token punctuation">)</span>  <span class="token comment">## the Lisp way, but let&apos;s ignore this</span>
</pre><pre class="language-text">(:call, :-, (:call, :+, (:call, :*, 3, (:call, :^, :x, 2)), (:call, :*, 4, :x)), (:call, :*, 3, (:call, :sin, :x)))
</pre>
<p>Let&apos;s stick with <code>dump</code></p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">ex <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
dump<span class="token punctuation">(</span>ex<span class="token punctuation">)</span>
</pre><pre class="language-text">Expr 
  head: Symbol call
  args: Array(Any,(3,))
    1: Symbol *
    2: Expr 
      head: Symbol call
      args: Array(Any,(3,))
        1: Symbol -
        2: Symbol x
        3: Int64 1
      typ: Any
    3: Expr 
      head: Symbol call
      args: Array(Any,(3,))
        1: Symbol -
        2: Symbol x
        3: Int64 2
      typ: Any
  typ: Any
</pre>
<p>Now we can also access what is inside the type, using our <code>.fieldnames</code> syntax</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">dump<span class="token punctuation">(</span>ex<span class="token punctuation">)</span>

ex<span class="token punctuation">.</span>head
ex<span class="token punctuation">.</span>args

julia<span class="token operator">&gt;</span> ex<span class="token punctuation">.</span>head
<span class="token punctuation">:</span>call  <span class="token comment">## a function call</span>

julia<span class="token operator">&gt;</span> ex<span class="token punctuation">.</span>args
<span class="token number">3</span><span class="token operator">-</span>element Array<span class="token punctuation">{</span>Any<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">:</span>
 <span class="token punctuation">:</span><span class="token operator">*</span> 
 <span class="token punctuation">:</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
 <span class="token punctuation">:</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span>

</pre><p>We can also go one level further. The first element of the array <code>ex.args</code> is the function to be called:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">ex<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
ex<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
typeof<span class="token punctuation">(</span>ans<span class="token punctuation">)</span> <span class="token comment"># that is, it is itself an `Expr`ession:</span>
</pre><p>Thus the structure of <code>Expr</code>essions is fundamentally recursive, and so lends itself naturally to recursive algorithms. We can dive, in turn, into the structure of each element:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">ex2 <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span>a <span class="token operator">=</span> b <span class="token operator">+</span> c<span class="token punctuation">)</span>
ex2<span class="token punctuation">.</span>head

ex<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>


ex<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>args


ex<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>


</pre><p>Also with the example we started</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">ex<span class="token punctuation">.</span>head
ex<span class="token punctuation">.</span>args
ex<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
ex<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
ex<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
typeof<span class="token punctuation">(</span>ex<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

</pre><p>We see that it has a special <code>Symbol</code> type, which represents the atoms (smallest parts) of an expression.</p>
<h2 class="mume-header" id="modifying-expressions">Modifying expressions</h2>

<p>Now, what happens if we <strong>modify</strong> this?  Let&apos;s make a copy of the expression first so that we can compare the two. Wht copy? Because we just created a different copy (deepcopy is not necessary!)</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">ex <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ex2 <span class="token operator">=</span> copy<span class="token punctuation">(</span>ex<span class="token punctuation">)</span>

ex2<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">:</span>z
ex2
ex
ex2<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
ex2<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">:</span>z

</pre><p>We have changed something inside the object <code>ex2</code>, so let&apos;s look at it:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">ex2
ex
</pre><p>The original expression has, indeed, changed! That is, <strong>we have taken a piece of Julia code, and used Julia itself to manipulate it into a different piece of Julia code</strong>. <strong>This is one of the simplest examples of metaprogramming</strong>. Now we can define <code>x</code> and <code>z</code> and evaluate the expressions:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">x <span class="token operator">=</span> <span class="token number">3.5</span><span class="token punctuation">;</span> z <span class="token operator">=</span> <span class="token number">4.5</span>
eval<span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">,</span> eval<span class="token punctuation">(</span>ex2<span class="token punctuation">)</span>  <span class="token comment">## And of course they will be different</span>
</pre><h2 class="mume-header" id="walking-a-syntax-tree">Walking a syntax tree</h2>

<p>What if we wanted to replace <em>all</em> of the <code>x</code>s in a given expression?</p>
<p>The problem is that they may be buried arbitrarily deeply in the nested syntax tree. So we have to traverse the tree, in order to visit each piece of it and check if it is an <code>:x</code>. So I need to have an algorithm which will go to each nodes of the tree and checks whether this is an <code>x</code> if it is, then it is going to change it to <code>z</code>. This is maybe possible, right? Important thing is I have to visit each node in some way and check whether I have <code>x</code></p>
<p>Here is a function that takes an expression object and replaces <strong>all</strong> of the <code>:x</code>s by <code>:z</code>s.</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia"><span class="token keyword">function</span> traverse<span class="token operator">!</span><span class="token punctuation">(</span>ex<span class="token punctuation">::</span>Expr<span class="token punctuation">,</span> find<span class="token punctuation">,</span> replace<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> arg<span class="token punctuation">)</span> <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>ex<span class="token punctuation">.</span>args<span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> arg <span class="token operator">==</span> find
            ex<span class="token punctuation">.</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> replace   <span class="token comment"># we cannot use arg here, since it is a copy, not a reference</span>
        <span class="token keyword">end</span>
        
        <span class="token keyword">if</span> isa<span class="token punctuation">(</span>arg<span class="token punctuation">,</span> Expr<span class="token punctuation">)</span>
            traverse<span class="token operator">!</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> find<span class="token punctuation">,</span> replace<span class="token punctuation">)</span>   <span class="token comment"># recursive</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    
    ex
<span class="token keyword">end</span>
</pre><p>It&apos;s calling the function recursively and replacing. Typical example of a recursion</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia"><span class="token keyword">function</span> recur_factorial<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
   <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">1</span>
       <span class="token keyword">return</span> n
   <span class="token keyword">else</span>
       <span class="token keyword">return</span> n<span class="token operator">*</span>recur_factorial<span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>

<span class="token keyword">end</span>

recur_factorial<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token number">10</span><span class="token operator">*</span><span class="token number">9</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">*</span><span class="token number">7</span><span class="token operator">*</span><span class="token number">6</span><span class="token operator">*</span><span class="token number">5</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">2</span>

</pre><pre data-role="codeBlock" data-info="julia" class="language-julia">traverse<span class="token operator">!</span><span class="token punctuation">(</span> <span class="token punctuation">:</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span> <span class="token punctuation">)</span>
</pre><p>This is, of course, not general enough - for example, we cannot replace something of the form <code>:(x - a)</code> with <code>:(x - 2a)</code> with the current version; this would require more sophisticated pattern matching capabilities - but it demonstrates the basic idea.</p>
<h2 class="mume-header" id="code-generation">Code generation</h2>

<p>Let&apos;s return to the original question: how to create a long polynomial expression.
So far, we have not seen how to <em>add</em> code, only <em>change</em> code that is already there.</p>
<p>A natural idea is to build the code up step by step; this is known as <strong>code generation</strong>.</p>
<p>Let&apos;s start again from the first term:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">ex <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
typeof<span class="token punctuation">(</span>ex<span class="token punctuation">)</span>
ex_new <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span>ex <span class="token operator">*</span> <span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">## not correct</span>
</pre><p>We would like to take what we have and create code that is &quot;what we have multiplied by <code>:(x-2)</code>&quot;. Let&apos;s try. This doesn&apos;t work, since <code>ex</code> is treated as a symbol, whereas we need the <em>value</em> contained in the <em>variable</em> called <code>ex</code>. This is obtained using the <code>$</code> operator, a procedure called <strong>interpolation</strong>. (Compare this to string interpolation.)</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">name <span class="token operator">=</span> <span class="token string">&quot;David&quot;</span>
s <span class="token operator">=</span> <span class="token string">&quot;Hello $name&quot;</span>  <span class="token comment">## string interpolation</span>
</pre><pre data-role="codeBlock" data-info="julia" class="language-julia">ex <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span> <span class="token operator">$</span>ex <span class="token operator">*</span> <span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>

<span class="token comment"># Now we can continue:</span>
ex <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span> <span class="token operator">$</span>ex <span class="token operator">*</span> <span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> 


</pre><p>Finally we see how to construct our loop:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">n <span class="token operator">=</span> <span class="token number">10</span>
ex <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">2</span><span class="token punctuation">:</span>n
    ex <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span> <span class="token operator">$</span>ex <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> i<span class="token punctuation">)</span> <span class="token punctuation">)</span>  
<span class="token keyword">end</span>

julia<span class="token operator">&gt;</span> ex
<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> 

<span class="token comment">## So I get x-i everytime.</span>

</pre><p>This did not work, since once again we did not want &quot;the code &apos;<code>i</code>&apos;&quot;, but rather the value of the variable <code>i</code>. Now let&apos;s try this one,</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">n <span class="token operator">=</span> <span class="token number">10</span>

ex <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">2</span><span class="token punctuation">:</span>n
    ex <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span> <span class="token operator">$</span>ex <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token operator">$</span>i<span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token keyword">end</span>

ex
</pre><p>Pretty neat (Not because I did it, the way it shows!). This is almost what we would write by hand, except for the large number of parentheses. Now let&apos;s do <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">n = 100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">100</span></span></span></span></p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">n <span class="token operator">=</span> <span class="token number">100</span>

ex <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">2</span><span class="token punctuation">:</span>n
    ex <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span> <span class="token operator">$</span>ex <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token operator">$</span>i<span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token keyword">end</span>

ex
</pre><p>Now we have the right hand side of the function, but we need the left hand side, which is the name of the function, so I can have the name of the function as,</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">n <span class="token operator">=</span> <span class="token number">10</span>
name <span class="token operator">=</span> Symbol<span class="token punctuation">(</span><span class="token string">&quot;p_&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token comment">## note if you give string, it keeps string, if you give variable it evaluates</span>
</pre><p>The code is then</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">code <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span> <span class="token operator">$</span>name<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">$</span>ex <span class="token punctuation">)</span>
</pre><p>We can wrap this inside a function,</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia"><span class="token keyword">function</span> make_wilkinson<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    
    ex <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">2</span><span class="token punctuation">:</span>n
        ex <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span> <span class="token operator">$</span>ex <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token operator">$</span>i<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    
    name <span class="token operator">=</span> Symbol<span class="token punctuation">(</span><span class="token string">&quot;p_&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span> 
    code <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span> <span class="token operator">$</span>name<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">$</span>ex <span class="token punctuation">)</span>
    
    eval<span class="token punctuation">(</span>code<span class="token punctuation">)</span>  <span class="token comment">## this is a bit dirty, using eval, eval is always in gloabal... that is why it is </span>
    <span class="token comment">## discouraged</span>
<span class="token keyword">end</span> 
</pre><pre data-role="codeBlock" data-info="julia" class="language-julia">x <span class="token operator">=</span> <span class="token number">2</span>
<span class="token keyword">function</span> check_eval<span class="token punctuation">(</span><span class="token punctuation">)</span>
     eval<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">(</span>y <span class="token operator">=</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>  

check_eval<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p>Finally we evaluate this:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">make_wilkinson<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment">##  it makes the function p_10</span>
make_wilkinson<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>

p_10<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
p_100<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>


</pre><p>This creates a function with the name <code>p_10</code> that does what we would write by hand.</p>
<p>Let&apos;s compare the two options by evaluating the function on a grid of values:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia"><span class="token keyword">function</span> f1<span class="token punctuation">(</span>range<span class="token punctuation">)</span>
    total <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> range
        total <span class="token operator">+=</span> p_100<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token keyword">return</span> total
<span class="token keyword">end</span>

<span class="token keyword">function</span> f2<span class="token punctuation">(</span>range<span class="token punctuation">)</span>
    total <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> range
        total <span class="token operator">+=</span> wilkinson<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token keyword">return</span> total
<span class="token keyword">end</span>
</pre><pre data-role="codeBlock" data-info="julia" class="language-julia">range <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">0.000001</span><span class="token punctuation">:</span><span class="token number">10</span>
t1 <span class="token operator">=</span> @elapsed f1<span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>
t2 <span class="token operator">=</span> @elapsed f2<span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>
t2 <span class="token operator">/</span> t1  <span class="token comment">## around 20% gain in performance</span>
</pre><p>We see that the generated code with the unrolled loop is 10% faster than the naive loop with 100 terms.</p>
<h3 class="mume-header" id="starting-from-empty">Starting from empty</h3>

<p>In some cases, it is useful to start from something empty and add statements to it.
To do this, we can do, for example,</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">code <span class="token operator">=</span> <span class="token keyword">quote</span> <span class="token keyword">end</span>   <span class="token comment"># empty</span>
dump<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
</pre><p>We can add statements using the standard Julia <code>push!</code>:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">Base<span class="token punctuation">.</span>push<span class="token operator">!</span><span class="token punctuation">(</span>code<span class="token punctuation">.</span>args<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">(</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
Base<span class="token punctuation">.</span>push<span class="token operator">!</span><span class="token punctuation">(</span>code<span class="token punctuation">.</span>args<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">(</span>b <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
code
</pre><pre data-role="codeBlock" data-info="julia" class="language-julia">eval<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="julia" class="language-julia">dump<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">(</span>a <span class="token operator">*</span> b <span class="token operator">*</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre class="language-text">Expr 
  head: Symbol call
  args: Array(Any,(4,))
    1: Symbol *
    2: Symbol a
    3: Symbol b
    4: Symbol c
  typ: Any
</pre>
<p><strong>Exercise</strong>: Build up the Wilkinson example using this technique.</p>
<h2 class="mume-header" id="repetitive-code">Repetitive code</h2>

<p>Code generation is used frequently in Julia code when repetitive code is required. For example, let&apos;s return to the idea of wrapping a type:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia"><span class="token keyword">struct</span> OurFloat
    x<span class="token punctuation">::</span>Float64
<span class="token keyword">end</span>
</pre><p>We can generate objects of this type:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">a <span class="token operator">=</span> OurFloat<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> OurFloat<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
</pre><p>But arithmetic operations are not defined:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">a <span class="token operator">+</span> b
</pre><p>We can define them in the natural way:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia"><span class="token keyword">import</span> Base<span class="token punctuation">:</span> <span class="token operator">+</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token operator">/</span>
<span class="token operator">+</span><span class="token punctuation">(</span>a<span class="token punctuation">::</span>OurFloat<span class="token punctuation">,</span> b<span class="token punctuation">::</span>OurFloat<span class="token punctuation">)</span> <span class="token operator">=</span> a<span class="token punctuation">.</span>x <span class="token operator">+</span> b<span class="token punctuation">.</span>x
<span class="token operator">-</span><span class="token punctuation">(</span>a<span class="token punctuation">::</span>OurFloat<span class="token punctuation">,</span> b<span class="token punctuation">::</span>OurFloat<span class="token punctuation">)</span> <span class="token operator">=</span> a<span class="token punctuation">.</span>x <span class="token operator">-</span> b<span class="token punctuation">.</span>x
</pre><p>But this will quickly get dull, and we could easily make a mistake.
As usual, whenever we are repeating something more than twice, we should try to automate it.</p>
<p>We have some code of the form</p>
<pre class="language-text">*op*(a::OurFloat, b::OurFloat) = a.x *op* b.x
</pre>
<p>where <code>*op*</code> is supposed to represent the operator. Julia allows us to do this almost literally; we just need to substitute in the <em>value</em> of the <em>variable</em> <code>op</code>!</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia">@show x

<span class="token comment">## prints, name = value</span>

</pre><p>Following is just for checking</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia"><span class="token keyword">for</span> op <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token operator">+</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token operator">-</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token operator">/</span><span class="token punctuation">)</span>
    @show op  <span class="token comment">## name </span>
    code <span class="token operator">=</span> <span class="token punctuation">:</span><span class="token punctuation">(</span> <span class="token operator">$</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">(</span>a<span class="token punctuation">::</span>OurFloat<span class="token punctuation">,</span> b<span class="token punctuation">::</span>OurFloat<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">$</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>x<span class="token punctuation">,</span> b<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    @show code
<span class="token keyword">end</span>
</pre><pre class="language-text">op = :+
code = :(a::OurFloat + b::OurFloat = begin  # In[127], line 3:
            a.x + b.x
        end)
op = :-
code = :(a::OurFloat - b::OurFloat = begin  # In[127], line 3:
            a.x - b.x
        end)
op = :*
code = :(a::OurFloat * b::OurFloat = begin  # In[127], line 3:
            a.x * b.x
        end)
op = :/
code = :(a::OurFloat / b::OurFloat = begin  # In[127], line 3:
            a.x / b.x
        end)
</pre>
<p>Finally we need to evaluate the code. The combination of <code>eval</code> and <code>:(...)</code> that we used above can be abbreviated to <code>@eval</code>:</p>
<pre data-role="codeBlock" data-info="julia" class="language-julia"><span class="token keyword">for</span> op <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token operator">+</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token operator">-</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token operator">/</span><span class="token punctuation">)</span>
    @eval <span class="token operator">$</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">(</span>a<span class="token punctuation">::</span>OurFloat<span class="token punctuation">,</span> b<span class="token punctuation">::</span>OurFloat<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">$</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>x<span class="token punctuation">,</span> b<span class="token punctuation">.</span>x<span class="token punctuation">)</span> 
<span class="token keyword">end</span>
</pre><pre data-role="codeBlock" data-info="julia" class="language-julia">a<span class="token operator">*</span>b
@which a<span class="token operator">*</span>b
</pre><pre data-role="codeBlock" data-info="julia" class="language-julia">@which sin<span class="token punctuation">(</span><span class="token number">3.5</span><span class="token punctuation">)</span>
</pre>
      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>